<script>
import { mapActions, mapGetters, mapState } from 'vuex';
import { GlAvatar, GlLink, GlTooltipDirective } from '@gitlab/ui';

import {
  SEVERITY_GROUP_TYPES,
  SEVERITY_LEVEL_TYPES,
} from 'ee/security_dashboard/store/modules/vulnerable_projects/constants';

import { Accordion, AccordionItem } from 'ee/vue_shared/components/accordion';
import Icon from '~/vue_shared/components/icon.vue';

export default {
  css: {
    severityGroups: {
      [SEVERITY_GROUP_TYPES.F]: ['gl-bg-red-100', 'gl-text-red-700'],
      [SEVERITY_GROUP_TYPES.D]: ['gl-bg-orange-100', 'gl-text-orange-700'],
      [SEVERITY_GROUP_TYPES.C]: ['gl-bg-purple-light', 'gl-text-purple'],
      [SEVERITY_GROUP_TYPES.B]: ['gl-bg-gray-100', 'gl-text-gray-800'],
      [SEVERITY_GROUP_TYPES.A]: ['gl-bg-green-100', 'gl-text-green-700'],
    },
    vulnerabilityTypes: {
      [SEVERITY_LEVEL_TYPES.critical]: ['gl-text-red-700'],
      [SEVERITY_LEVEL_TYPES.high]: ['gl-text-orange-700'],
      [SEVERITY_LEVEL_TYPES.medium]: ['gl-text-purple'],
      [SEVERITY_LEVEL_TYPES.unknown]: ['gl-text-gray-800'],
      [SEVERITY_LEVEL_TYPES.low]: ['gl-text-gray-800'],
    },
  },
  accordionItemsContentMaxHeight: '445px',
  components: { Accordion, AccordionItem, GlLink, GlAvatar, Icon },
  directives: {
    'gl-tooltip': GlTooltipDirective,
  },
  props: {
    endpoint: {
      type: String,
      required: true,
    },
    helpPagePath: {
      type: String,
      required: false,
      default: '',
    },
  },
  computed: {
    ...mapState('vulnerableProjects', ['isLoading']),
    ...mapGetters('vulnerableProjects', ['severityGroups']),
  },
  created() {
    this.fetchProjects(this.endpoint);
  },
  methods: {
    ...mapActions('vulnerableProjects', ['fetchProjects']),
    shouldAccordionItemBeDisabled({ projects }) {
      return projects.length < 1;
    },
    getClassesForSeverityGroup({ name }) {
      return this.$options.css.severityGroups[name] || [];
    },
  },
};
</script>

<template>
  <section class="border rounded">
    <header class="border-bottom p-3">
      <h4 class="my-0">
        {{ __('Project security status') }}
        <gl-link
          v-if="helpPagePath"
          :href="helpPagePath"
          :aria-label="__('Project security status help page')"
          target="_blank"
          ><icon name="question"
        /></gl-link>
      </h4>
      <p class="text-secondary m-0">
        {{ __('Projects scored by vulnerability severity type detected') }}
      </p>
    </header>
    <accordion class="px-3">
      <accordion-item
        v-for="severityGroup in severityGroups"
        :key="severityGroup.name"
        :is-loading="isLoading"
        :disabled="shouldAccordionItemBeDisabled(severityGroup)"
        :max-height="$options.accordionItemsContentMaxHeight"
      >
        <template #title="{ isExpanded, isDisabled }"
          ><h5 class="d-flex align-items-center font-weight-normal p-0 m-0">
            <gl-avatar
              v-gl-tooltip
              :title="severityGroup.description"
              :entity-name="severityGroup.name"
              shape="circle"
              :size="32"
              class="mr-2 border-0 font-weight-bold"
              :class="getClassesForSeverityGroup(severityGroup)"
            />
            <span :class="{ 'font-weight-bold': isExpanded, 'text-secondary': isDisabled }">
              {{ n__('%d project', '%d projects', severityGroup.projects.length) }}
            </span>
          </h5>
        </template>
        <template #subTitle>
          <p class="m-0 ml-5 pb-1 text-secondary">{{ severityGroup.warning }}</p>
        </template>
        <div class="ml-5 pb-2">
          <ul class="list-unstyled">
            <li v-for="project in severityGroup.projects" :key="project.id" class="py-2">
              <gl-link target="_blank" :href="`${project.path}/security/dashboard`">{{
                project.name
              }}</gl-link>
              <span
                v-if="project.mostSevere.count"
                ref="mostSevereCount"
                class="d-block"
                :class="$options.css.vulnerabilityTypes[project.mostSevere.name]"
                >{{ project.mostSevere.name }} {{ project.mostSevere.count }}</span
              >
            </li>
          </ul>
        </div>
      </accordion-item>
    </accordion>
  </section>
</template>
