<script>
import { mapActions, mapGetters, mapState } from 'vuex';
import { GlAvatar, GlLink, GlTooltipDirective } from '@gitlab/ui';

import { Accordion, AccordionItem } from 'ee/vue_shared/components/accordion';
import Icon from '~/vue_shared/components/icon.vue';

export default {
  components: { Accordion, AccordionItem, GlLink, GlAvatar, Icon },
  directives: {
    'gl-tooltip': GlTooltipDirective,
  },
  computed: {
    ...mapState('securityStatus', ['isLoading']),
    ...mapGetters('securityStatus', ['projectsBySeverityLevels', 'mostSevereVulnerabilityCount']),
  },
  created() {
    // @TODO - inject this
    this.fetchProjects('/groups/devstuff/-/security/vulnerable_projects');
  },
  methods: {
    ...mapActions('securityStatus', ['fetchProjects']),
  },
};
</script>

<template>
  <section class="border rounded">
    <header class="border-bottom p-3">
      <h4 class="my-0">
        {{ __('Project security status') }}
        <gl-link target="_blank" href="http://todo.com" :aria-label="__('todo')"
          ><icon name="question"
        /></gl-link>
      </h4>
      <p class="text-secondary m-0">
        {{ __('Projects scored by vulnerability severity type detected') }}
      </p>
    </header>
    <accordion :is-loading="isLoading" class="px-3">
      <accordion-item
        v-for="[severityLevelName, { projects }] in Object.entries(projectsBySeverityLevels)"
        :key="severityLevelName"
        :disabled="projects.length < 1"
      >
        <template #title="{ isExpanded, isDisabled }"
          ><h5 class="d-flex align-items-center font-weight-normal p-0 m-0">
            <gl-avatar
              v-gl-tooltip
              title="blabla"
              :entity-name="severityLevelName"
              shape="circle"
              :size="32"
              class="mr-2 gl-text-red-600"
            />
            <span :class="{ 'font-weight-bold': isExpanded, 'text-secondary': isDisabled }">
              {{ n__('%d project', '%d projects', projects.length) }}
            </span>
          </h5>
        </template>
        <template #titleSubheader>
          <p class="text-secondary m-0">Some subtext</p>
        </template>
        <ul class="list-unstyled pl-5">
          <li v-for="project in projects" :key="project.id" class="py-1">
            <!--            @TODO - switch with glLink -->
            <a :href="`${project.full_path}/security/dashboard`" target="_blank">{{ project.full_name }}</a>
            <span class="d-block">{{ project.mostCritical.type}} {{ project.mostCritical.count }}</span>
          </li>
        </ul>
      </accordion-item>
    </accordion>
  </section>
</template>
